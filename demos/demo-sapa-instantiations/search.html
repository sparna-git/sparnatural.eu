<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>SAPA Search Instantiations/Files</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,700|Open+Sans:300,300i,400,400i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- Font Awesome -->    
  <link rel="stylesheet" href="assets/fa6/css/all.min.css" />

  <!-- YASGUI CSS -->
  <link href="https://unpkg.com/@triply/yasgui/build/yasgui.min.css" rel="stylesheet" type="text/css" />

  <link href="sparnatural-form.css" rel="stylesheet">

  <style>
    .yasqe .CodeMirror {
      font-size: 0.8em;
    }

    #first-section {
      padding-top: 115px;
      height: auto;
      overflow: visible;
    }

    .nav-tabs .form-tab.active {
      background-color:#e8fcf5;
      border-color: #dee2e6 #dee2e6 #e8fcf5;
    }

    input.switch {
      --s: 20px; /* adjust this to control the size*/
      
      height: calc(var(--s) + var(--s)/5);
      width: auto; /* some browsers need this */
      aspect-ratio: 2.25;
      border-radius: var(--s);
      /* margin: calc(var(--s)/2); */
      display: grid;
      cursor: pointer;
      background-color:#85ff7a;
      box-sizing: content-box;
      overflow: hidden;
      transition: .3s .1s;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    input.switch:before{
      content: "";
      padding: calc(var(--s)/10);
      --_g: radial-gradient(circle closest-side at calc(100% - var(--s)/2) 50%,#000 96%,#0000);
      background: 
        var(--_g) 0 /var(--_p,var(--s)) 100% no-repeat content-box,
        var(--_g) var(--_p,0)/var(--s)  100% no-repeat content-box,
        #fff;
      mix-blend-mode: darken;
      filter: blur(calc(var(--s)/12)) contrast(11);
      transition: .4s, background-position .4s .1s,
        padding cubic-bezier(0,calc(var(--_i,-1)*200),1,calc(var(--_i,-1)*200)) .25s .1s;
    }
    input.switch:checked {
      background-color: #ff7a7a;
    }
    input.switch:checked:before {
      padding: calc(var(--s)/10 + .05px) calc(var(--s)/10);
      --_p: 100%;
      --_i: 1;
    }
  </style>

</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top d-flex align-items-center">
    <div class="container d-flex justify-content-between align-items-center">

      <div id="logo">
        <h1 data-i18n="page.title"></h1>
      </div>

      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link" href="index.html">Advanced query</a></li>
          <li><a class="nav-link active" href="search.html">Simple search</a></li>
          <li class="dropdown"><a href="#"><i style="font-size:25px;" class="fa-thin fa-globe-africa"></i>&nbsp;<span>Lang.</span> <i class="bi bi-chevron-down"></i></a>
            <ul style="width:80%;">
              <li><a href="?lang=fr">fr</a></li>
              <li><a href="?lang=en">en</a></li>
            </ul>
          </li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->
    </div>
  </header><!-- End Header -->

    <!-- ======= First Section ======= -->
    <section id="first-section">
      <div class="container-fluid">
        <div class="row">

          <div class="col-md-3">

            <ul class="nav nav-tabs">
              <li class="nav-item">
                <a class="nav-link form-tab" id="tab-files" aria-current="page" href="#" data-bs-toggle="tab" data-bs-target="#sparnatural-form-files">Files</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active form-tab" id="tab-instantiations" href="#" data-bs-toggle="tab" data-bs-target="#sparnatural-form-instantiations">Instantiations</a>
              </li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">

              <div class="tab-pane" id="sparnatural-form-files">
                <!-- Sparnatural Form -->
                <sparnatural-form
                  src="https://xls2rdf.sparna.fr/rest/convert?url=https%3A%2F%2Fdocs.google.com%2Fspreadsheets%2Fd%2F1WrC2r7yDQCP5AKhu6SAK8Ba_QshzFKmm%2Fexport%3Fformat%3Dxlsx&noPostProcessings=true https://xls2rdf.sparna.fr/rest/convert?url=https%3A%2F%2Fdocs.google.com%2Fspreadsheets%2Fd%2F1UWfCJmgvgwJ0yOs6Ox_qzn47heaiQ0cx%2Fexport%3Fformat%3Dxlsx&noPostProcessings=true form-configs/collections-shacl.ttl"
                  lang="en"
                  defaultLang="en"
                  limit="1000"
                  endpoint="https://proxy.sparnatural.eu/sparql-proxy/sparql?endpoint=https%3A%2F%2Fwww.dev.performing-arts.ch%2Fsparql"
                  form="form-configs/files/form.json"
                  prefixes="skos:http://www.w3.org/2004/02/skos/core# rico:https://www.ica.org/standards/RiC/ontology# spao:http://ontology.performing-arts.ch/ ebucore:https://www.ebu.ch/metadata/ontologies/ebucore# crm:http://www.cidoc-crm.org/cidoc-crm/ premis:http://www.loc.gov/premis/rdf/v1#"
                  query="form-configs/files/query.json"
                ></sparnatural-form>
              </div>
              <div class="tab-pane active" id="sparnatural-form-instantiations">
                <!-- Sparnatural Form -->
                <sparnatural-form
                  src="https://xls2rdf.sparna.fr/rest/convert?url=https%3A%2F%2Fdocs.google.com%2Fspreadsheets%2Fd%2F1WrC2r7yDQCP5AKhu6SAK8Ba_QshzFKmm%2Fexport%3Fformat%3Dxlsx&noPostProcessings=true https://xls2rdf.sparna.fr/rest/convert?url=https%3A%2F%2Fdocs.google.com%2Fspreadsheets%2Fd%2F1UWfCJmgvgwJ0yOs6Ox_qzn47heaiQ0cx%2Fexport%3Fformat%3Dxlsx&noPostProcessings=true form-configs/collections-shacl.ttl"
                  lang="en"
                  defaultLang="en"
                  limit="1000"
                  endpoint="https://proxy.sparnatural.eu/sparql-proxy/sparql?endpoint=https%3A%2F%2Fwww.dev.performing-arts.ch%2Fsparql"
                  form="form-configs/instantiations/form.json"
                  prefixes="skos:http://www.w3.org/2004/02/skos/core# rico:https://www.ica.org/standards/RiC/ontology# spao:http://ontology.performing-arts.ch/ ebucore:https://www.ebu.ch/metadata/ontologies/ebucore# crm:http://www.cidoc-crm.org/cidoc-crm/ premis:http://www.loc.gov/premis/rdf/v1#"
                  query="form-configs/instantiations/query.json"
                ></sparnatural-form>
              </div>

            </div>

            <div class="row">
              <div class="col-md-2">
                  <input type="checkbox" class="switch" id="prodSwitch" autocomplete="off" />
              </div>
              <div class="col-md-10">
                  <span id="dev">Queries are sent to <a href="https://www.dev.performing-arts.ch/sparql">DEV</a></span>
                  <span id="prod" style="display:none;">Queries are sent to <a href="https://www.performing-arts.ch/sparql">PROD</a></span>
              </div>
            </div>

          </div>

          <!-- Éditeur SPARQL à droite -->
          <div class="col-md-9">
            <div class="row">
              <div class="col-md-12">
                  <a href="#" id="sparql-toggle"><i id="sparql-toggle-icon" class="fad fa-eye fa-fw"></i>&nbsp; <span data-i18n="actions.toggle"></span></a>
              </div>
            </div>
            <div class="row">
              <div  class="col-md-12">
                <div id="yasqe"  style="display:none;"></div>
              </div>
            </div>

            <div class="row result-container">
              <div id="yasr"></div>
            </div>
          </div>

        </div>
      </div>
    </section><!-- End First Section -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-chevron-up"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/demo.js"></script>

  <!-- Sparnatural-specific -->

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"></script>
    <!--
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    -->
    <script src="assets/vendor/bootstrap/js/bootstrap.min.js" ></script>

    <!-- YASGUI stuff -->
    <script src="https://unpkg.com/@triply/yasgui/build/yasgui.min.js"></script>

    <!-- Sparnatural Javascript -->
    <script type="text/javascript" src="./sparnatural.js"></script>
    <script type="text/javascript" src="./sparnatural-yasgui-plugins.js"></script>
    <script type="text/javascript" src="./sparnatural-form.js"></script>

  <!-- /Sparnatural-specific -->

  <!-- i18n -->
  <script src="assets/vendor/jquery.i18n/jquery.i18n.js"></script>
  <script src="assets/vendor/jquery.i18n/jquery.i18n.messagestore.js"></script>
  <script src="assets/vendor/jquery.i18n/jquery.i18n.fallbacks.js"></script>
  <script src="assets/vendor/jquery.i18n/jquery.i18n.language.js"></script>
  <script src="assets/vendor/jquery.i18n/jquery.i18n.parser.js"></script>
  <script src="assets/vendor/jquery.i18n/jquery.i18n.emitter.js"></script>

  <!-- Json url (Compression) -->
  <script src="https://cdn.jsdelivr.net/gh/masotime/json-url@master/dist/browser/json-url.js"></script>

  <!-- Sheperd -->

    <script>
      $.urlParam = function(name){
        var results = new RegExp('[\\?&amp;]' + name + '=([^&amp;#]*)').exec(window.location.href);
        if(results == null) { return null; }
        return results[1] || 0;
      }
      var lang = ($.urlParam('lang') != null)?$.urlParam('lang'):'en';

      // set the locale
      $.i18n( { locale: lang } );  
      $.i18n().load( {
          'en': {
            'page.title': 'Search Instantiations/Files',
            'menu.home': 'Sparnatural',
            'menu.lang': 'Lang.',
            'actions.toggle': 'Toggle SPARQL'
          },
          'fr': {
            'page.title': 'Search Instantiations/Files',
            'menu.home': 'Sparnatural',
            'menu.lang': 'Lang.',
            'actions.toggle': 'Voir/masquer SPARQL'
          }
      } );  
      $('body').i18n();

      // Select the Sparnatural form component
      const sparnaturalForms = document.querySelectorAll("sparnatural-form");

      if(lang == "fr") { 
        sparnaturalForms.forEach(form => {
          form.setAttribute("lang", "fr");
        });        
      }

      sparnaturalForms[0].addEventListener("init", (event) => {
        // Notify all plugins of configuration updates if they support it
        for (const plugin in yasr.plugins) {
          if (yasr.plugins[plugin].notifyConfiguration) {
            yasr.plugins[plugin].notifyConfiguration(
              sparnaturalForms[0].sparnaturalForm.specProvider
            );
          }
        }
      });


      sparnaturalForms.forEach(form => {
        // Listen for updates to the query and pass to YASQE
        form.addEventListener("queryUpdated", (event) => {
          console.log(event.detail.queryString)
          const queryString = form.expandSparql(
            event.detail.queryString
          );

          // Update YASQE with the new SPARQL query
          yasqe.setValue(queryString);

          for (const plugin in yasr.plugins) {
            if (yasr.plugins[plugin].notifyQuery) {
              yasr.plugins[plugin].notifyQuery(event.detail.queryJson);
            }
          }
        });
      });

      sparnaturalForms.forEach(form => {
        // Listen for form submission and trigger YASQE query
        form.addEventListener("submit", () => {
          form.disablePlayBtn();

          // Afficher un message ou un spinner temporaire dans YASR
          yasr.setResponse({
            contentType: "text/html",
            data: {
              "head": {
                "vars": ["message"]
              },
              "results": {
                "bindings": [
                  {
                    "message": {
                      "type": "literal",
                      "value": "Chargement en cours..."
                    }
                  }
                ]
              }
            },
            status: 200
          });

          let finalResult = form.executeSparql(
            yasqe.getValue(),
            (finalResult) => {
              // send final result to YasR
              yasr.setResponse(finalResult);
              // re-enable submit button
              form.enablePlayBtn();
            },
            (error) => {
              console.error("Got an error when executing SPARQL in Sparnatural");
              console.dir(error);
            }
          );
        });      
      });

      const yasqe = new Yasqe(document.getElementById("yasqe"), {
        requestConfig: { 
          endpoint: $('#endpoint').text(),
          method: "GET",
          header: {}
        },
        copyEndpointOnNewTab: false  
      });

      Yasr.registerPlugin("TableX",SparnaturalYasguiPlugins.TableX);
      Yasr.registerPlugin("Grid",SparnaturalYasguiPlugins.GridPlugin);
      Yasr.registerPlugin("Stats",SparnaturalYasguiPlugins.StatsPlugin);

      delete Yasr.plugins['table'];
      delete Yasr.plugins['response'];
      const yasr = new Yasr(document.getElementById("yasr"), {
        pluginOrder: ["TableX", "Grid", "Stats"],
        defaultPlugin: "TableX",
        // disable persistency
        persistencyExpire: 0,
        maxPersistentResponseSize: 0
      });

      yasr.plugins["TableX"].persistentConfig.compact = true;
      yasr.plugins["TableX"].config.includeControls = true;
      yasr.plugins["TableX"].config.excludeColumnsFromCompactView = [
        // these 2 are for files
        "Size",
        "Standard",
        // these are all for instantiations
        "RepresentationType",
        "CarrierType",
        "RecordingSystem",
        "DerivedInstantiationConcat",
        "DerivedFromInstantiationConcat",
        "CopyPath",
        "History",
        "ContentDesc",
        "ModeOfAcq",
        "Material",
        "Condition",
        "Location",
        "PhysicalCharacteristics",
        "Color",
        "Standard",
        "DisplayMode",
        "VideoDamage",
        "ScanningFormat",
        "ScanningOrder",
        "Integrity",
        "PhysUsability",
        "InternalNote",
        "Note"
      ];

      if(lang == "fr") { 
        yasr.plugins["Grid"].config.lang = "fr";
        yasr.plugins["Stats"].config.lang = "fr";
      } else {
        yasr.plugins["Grid"].config.lang = "en";
        yasr.plugins["Stats"].config.lang = "en";
      }

      document.getElementById('sparql-toggle').onclick = function() {
        if(document.getElementById('yasqe').style.display == 'none') {
          document.getElementById('yasqe').style.display = 'block';
          yasqe.setValue(yasqe.getValue());
          yasqe.refresh();
          document.getElementById('sparql-toggle-icon').className = 'fad fa-eye-slash fa-fw';
        } else {
          document.getElementById('yasqe').style.display = 'none';
          document.getElementById('sparql-toggle-icon').className = 'fad fa-eye fa-fw';
        }
        return false;        
      } ;

      // tab management
      document.getElementById('tab-files').onclick = function() {
        if(!document.getElementById('tab-files').classList.contains("active")) {
          document.getElementById('tab-files').classList.add("active");
          document.getElementById('tab-instantiations').classList.remove("active");
        }
      }
      document.getElementById('tab-instantiations').onclick = function() {
        if(!document.getElementById('tab-instantiations').classList.contains("active")) {
          document.getElementById('tab-instantiations').classList.add("active");
          document.getElementById('tab-files').classList.remove("active");
        }
      }
      

      let toggleEndpointLabel = function() {
        if(document.getElementById('prodSwitch').checked) {
          document.getElementById('prod').style.display = 'inline';
          document.getElementById('dev').style.display = 'none';

          sparnaturalForms.forEach(form => {
            form.setAttribute("endpoint", "https://proxy.sparnatural.eu/sparql-proxy/sparql?endpoint=https%3A%2F%2Fwww.performing-arts.ch%2Fsparql");
          }); 
        } else {
          document.getElementById('prod').style.display = 'none';
          document.getElementById('dev').style.display = 'inline';

          sparnaturalForms.forEach(form => {
            form.setAttribute("endpoint", "https://proxy.sparnatural.eu/sparql-proxy/sparql?endpoint=https%3A%2F%2Fwww.dev.performing-arts.ch%2Fsparql");
          }); 
        }
        return false; 
      }

      document.getElementById('prodSwitch').onchange = toggleEndpointLabel;

    </script>

</body>

</html>